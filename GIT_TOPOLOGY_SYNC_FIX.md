# Git Topology Synchronization Fix\n\n## Problem\nNAS mirror (`origin`) has diverged from GitHub (`github`), causing non-fast-forward rejections during addon publishing.\n\n## Root Cause\n- GitHub main: `8de2dd589d4e559f90c65629696f7fcf7d5cd7cd`\n- NAS main: `eed64ccd2923a4536ee29679a57ce21458a8c312` \n- Divergence violates ADR-0019/ADR-0028 mirror policy\n\n## Solution (ADR-0028 Compliant)\n\n### Step 1: Backup Current States\n`bash\nSTAMP=$(date -u +%Y%m%dT%H%M%SZ)\necho \"Backup timestamp: $STAMP\"\n\n# Backup GitHub main\ngit push github github/main:refs/heads/backup/main-github-$STAMP\ngit push github github/main:refs/tags/backup/main-github-$STAMP\n\n# Backup NAS main  \ngit push origin origin/main:refs/heads/backup/main-nas-$STAMP\ngit push origin origin/main:refs/tags/backup/main-nas-$STAMP\n`\n\n### Step 2: Sync NAS Mirror to GitHub (ADR-0019 Pull-Through)\n`bash\n# Option A: NAS fetch from GitHub (preferred)\nssh gituser@ds220plus.reverse-beta.ts.net \"cd /volume1/git-mirrors/ha-config.git && git fetch --prune https://github.com/e-app-404/ha-bb8-addon.git +refs/heads/main:refs/heads/main\"\n\n# Option B: If fetch blocked, admin low-level update (ADR-0028)\nssh gituser@ds220plus.reverse-beta.ts.net \"cd /volume1/git-mirrors/ha-config.git && git update-ref refs/heads/main 8de2dd589d4e559f90c65629696f7fcf7d5cd7cd\"\n`\n\n### Step 3: Verify Triad Synchronization (ADR-0028)\n`bash\necho \"=== Verifying SHA alignment ===\"\necho \"Local HEAD: $(git rev-parse HEAD)\"\necho \"GitHub main: $(git ls-remote --heads github main | awk '{print $1}')\"\necho \"NAS main: $(git ls-remote --heads origin main | awk '{print $1}')\"\n# All should match after sync\n`\n\n### Step 4: Clean Workspace and Retry Release\n`bash\n# Clean workspace (remove unstaged changes)\ngit add docs/ADR/ADR-0033-dual-clone-topology-git-hygiene.md  # Keep ADR changes\ngit reset --hard HEAD\ngit clean -fd\n\n# Retry release with synchronized topology\nmake release-patch\n`\n\n## Alternative: Fix publish_addon_archive.sh (Long-term)\n\nThe script violates ADR-0033 by creating orphan commits. Consider modifying it to:\n\n1. **Use GitHub as primary remote** instead of origin\n2. **Implement proper dual-clone synchronization** \n3. **Add SHA verification** before force-push\n\n`bash\n# In ops/release/publish_addon_archive.sh, replace:\n# git push -f origin HEAD:\"${TARGET_BRANCH}\"\n\n# With ADR-0033 compliant approach:\nREMOTE_URL=\"$(git remote get-url github)\"\ngit push -f \"$REMOTE_URL\" HEAD:\"${TARGET_BRANCH}\"\n\n# Then sync NAS mirror via pull-through\n`\n\n## Prevention (ADR-0019 Compliance)\n\n1. **Always use GitHub as source of truth** for releases\n2. **NAS mirror should be pull-only** (no direct pushes)\n3. **Implement automated mirror sync** after GitHub updates\n4. **Add topology validation** to release scripts\n\n## Emergency Rollback\n\nIf sync fails:\n`bash\n# Restore GitHub main\ngit push --force-with-lease=main github backup/main-github-$STAMP:main\n\n# Restore NAS main\ngit push --force-with-lease=main origin backup/main-nas-$STAMP:main\n`\n\n## Receipt\nDate: 2025-09-29 \nAction: Git topology synchronization per ADR-0028 \nReason: Fix non-fast-forward rejection in addon publishing \nBackup refs: `backup/main-github-$STAMP`, `backup/main-nas-$STAMP`

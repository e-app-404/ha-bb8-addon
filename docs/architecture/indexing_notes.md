---
title: Workspace Indexing Notes
---

This document describes the per-folder `index.jsonl` and the global `workspace_inventory.jsonl` schema, and explains how Github Copilot (GPT-5 mini) or similar agents should consume these artifacts for effective, ADR-aware code suggestions and guardrails.

1. Goals
- Provide a compact, authoritative index so models can choose high-signal files without reading the whole repository.
- Mark generated files vs authored files to avoid noisy edits.
- Provide per-folder indexes for fast locality queries (e.g., "which files in ops/guardrails implement guard X?").

2. Files
- `docs/architecture/workspace_inventory.jsonl` — line-delimited JSON; coarse global seed of authoritative files and folders.
- `<folder>/index.jsonl` — per-folder JSONL file produced by `ops/guardrails/generate_index.py`.

3. Index entry schema (per-line JSON) — canonical fields

- path (string): path relative to repo root. Example: "addon/bb8_core/mqtt_dispatcher.py"
- name (string): file or folder name
- size (number): file size in bytes (0 for folders)
- sha256 (string): hex sha256 of file contents (empty for folders or unreadable files)
- category (string): one of: code.runtime, code.tooling, infra.metadata, governance, tests, docs, artifacts, artifacts.backup, other
- language (string|null): detected language (python, bash, yaml, toml, markdown, json, dockerfile, etc.)
- tags (array[string]): lightweight tags inferred from content (mqtt, ble, homeassistant, pytest, coverage, generated, doc, test, license)
- generated (boolean): true when common markers indicate autogenerated files ("DO NOT EDIT", "generated by ...")

New fields (added):

- meta (object|null): repository or file-level metadata discovered by sniffing manifests and license files. May include keys such as `project_name`, `author`, or `license_file`.

- binary (boolean): when set in `meta`, indicates this file is a binary or image and should not be read by LLMs.

Expanded tags: `ci`, `manifest`, `license`, `docker`, `generated` (already), plus technology badges found in README files (python, pytest, coverage, mqtt, homeassistant).

4. Consumption guidance for Copilot / GPT-5-mini

- Seed selection: load the global `workspace_inventory.jsonl` (up to token budget) and then retrieve per-folder `index.jsonl` only for folders relevant to the task (use tags/category to filter).
- Scoring heuristic (suggested):
  1) Exclude items with `generated=true` unless the task is to regenerate artifacts.
  2) Prioritize files matching `language` == task language.
  3) Boost files whose `tags` intersect the task intent (e.g., tag `mqtt` for MQTT-related edits).
  4) Use `category` to enforce ADR constraints: e.g., do not suggest moving files out of `addon/` without checking `docs/ADR/`.

5. Example usage patterns

- "Find the canonical MQTT topics used by the add-on":
  - Load `workspace_inventory.jsonl`, find `addon/bb8_core/mqtt_dispatcher.py` (tag mqtt, language python).
  - Load `addon/index.jsonl` to find other related modules (presence_scanner, common, discovery helpers).

- "Generate a guardrail that verifies discovery JSON retains are false":
  - Load `docs/ADR/ADR-0022-protocol-enforcement.md` and `ops/guardrails/topic_literal_checker.py`.
  - Use tags `homeassistant` and `governance` to seed rationale.

6. Operational notes
- Keep `index.jsonl` generated in CI or via pre-commit; a small step in CI can run `python ops/guardrails/generate_index.py` and fail if `index.jsonl` diff exists.
- Per-folder `index.jsonl` can be added to `.gitignore` if you prefer generated indexes not be committed, but for Copilot seeding we recommend committing them to ensure reproducibility.

Regeneration commands (local)

```bash
# from repo root
python3 ops/guardrails/generate_index.py
python3 ops/guardrails/build_relationships.py
```

To fail CI if indexes are out-of-date, run the generator and then `git diff --exit-code docs/architecture/* */index.jsonl`.

7. Evolution ideas
- Extend sniffing to parse `pyproject.toml` and `config.yaml` to extract authoritative keys (e.g., `tool.ruff`, `fail_under`) and expose them as tags/metadata in index entries.
- Add a `consumers`/`producers` field by static analysis (import graph for Python, topic usage extraction for MQTT) to improve relationship mapping.

8. Example index usage snippet (pseudocode)

```
# Load global inventory
seed = load_jsonl('docs/architecture/workspace_inventory.jsonl')
# Select candidate files by tag/language
candidates = [f for f in seed if 'mqtt' in f.tags and f.language == 'python' and not f.generated]
# Load per-folder index files for highest-ranked candidates
for c in candidates[:5]:
    folder_index = load_jsonl(os.path.join(repo_root, os.path.dirname(c.path), 'index.jsonl'))
    # now use folder_index to pick the most local files
```


Maintainers: ops/guardrails team

9. Prompt templates for Copilot / GPT

Use these short templates when seeding a model with index+relationship artifacts. Replace [] with task-specific text.

Template: find high-signal files
```
You are given a repo index (per-folder index.jsonl) and relationships.json (module imports and MQTT producers/consumers).
Task: [short task description]
Constraints: Do not edit files with `generated=true` unless the task is to regenerate artifacts.
Select up to 6 files to read in full. Prioritize files where `language` matches the task and `tags` intersect the task keywords.
Return a JSON array of file paths in preference order.
```

Template: propose a minimal change with ADR compliance
```
You have the selected files and `docs/ADR/` present. Produce a short patch (diff) that implements [feature/bugfix], and include a one-paragraph ADR check: which ADRs may be impacted and how the change complies or needs ADR updates.
```

Template: investigate MQTT topic ownership
```
Given relationships.json which maps modules -> producers and consumers for MQTT topics, answer: for topic [topic string], list producer modules, consumer modules, and a suggested owner module for documentation. If ownership is ambiguous, list criteria to pick an owner.
```

10. relationships.json usage

- `relationships.json` now includes per-module `imports`, `producers`, and `consumers` arrays.
- Use `producers` to find modules that publish/emit commands or state onto MQTT topics. Use `consumers` to find modules that subscribe or react to topics.
- The DOT graph (`reports/relationship_graph.dot`) visualizes producer (solid green) and consumer (dashed blue) edges. Use `dot -Tpng reports/relationship_graph.dot -o reports/relationship_graph.png` to render.

11. CI snippet (example)

Add a GitHub Actions step to regenerate and check freshness:

```yaml
- name: Regenerate indexes
  run: |
    python3 ops/guardrails/generate_index.py
    python3 ops/guardrails/build_relationships.py
    git --no-pager diff --exit-code docs/architecture/*.json docs/**/index.jsonl
```


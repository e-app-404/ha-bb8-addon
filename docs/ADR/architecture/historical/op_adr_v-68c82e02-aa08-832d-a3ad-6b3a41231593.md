````markdown
# ADR-2001: Testing & Validation Protocol (as observed)

**Session Evidence Source:** 
- §1 “Session Recap Summary” (Last validated checkpoint; Governance traits; Unresolved blockers)
- §2 “Artifact Reference Index”
- §3 “Phase + Output Registry”

## Context
The session focused on stabilizing tests/coverage, enforcing repo-shape, and validating the MQTT seam via a FakeMQTT runner (“bleep”). Evidence was discussed for test counts, coverage, CI guards, and artifact locations.

**Problem Statement:** Ensure repeatable, empirically validated CI with coverage and shape gates; verify MQTT seam without a real broker.

**Investigation Method:** Narrative evidence from the active session recap and phase registry; artifact paths enumerated for logs/reports.

**Evidence Gathered:**
- “Ratchet completed with **200+ tests passing**, **coverage ~69%**, bleep seam OK; remaining **1 failing test** (`test_resolve_topic_wildcard`) due to intentional wildcard sanitization.” (§1)
- “Coverage gate ≥ **70%** (ratcheted)” noted in Governance traits (§1) and P3 status (§3).
- Artifact paths listed for verification: `coverage.xml`, `reports/ratchet/pipeline_*.log`, `reports/bleep_run_*.log`. (§2)

## Decision
**Technical Choice:** Maintain CI gates with coverage threshold and repo-shape enforcement; validate MQTT via FakeMQTT (“bleep”) logs.

**Command/Configuration:** 
- CI workflows referenced: `.github/workflows/shape.yml`, `.github/workflows/tests.yml`. (§2)
- Coverage artifact: `coverage.xml`. (§2)
- Evidence/log locations: `reports/ratchet/pipeline_*.log`, `reports/bleep_run_*.log`. (§2)

**Validation Results:**
- Reported: 200+ tests passing; 1 failing test (`test_resolve_topic_wildcard`); coverage reported ~69%; coverage gate configured ≥70%. (§1, §3)
- Note: No raw log excerpts or command outputs were included in-session.

## Consequences

### Positive
- Clear CI acceptance surfaces: repo-shape guard and coverage gate. (§1, §3)
- MQTT seam validated via FakeMQTT (proof-of-life indicated). (§1, §2)

### Negative
- One test failing due to policy/test mismatch on topic wildcards. (§1)
- Potential inconsistency between “~69% coverage” and “gate ≥70% passes” requires verification. (§1, §3)

### Unknown/Untested
- No pasted test runner output, coverage XML snippet, or bleep log lines were shared.

## Implementation Evidence

### Commands Verified
```bash
# None were shown as executed with output during the session.
````

### Configuration Discovered

```yaml
# CI files referenced (contents not shown):
.github/workflows/shape.yml
.github/workflows/tests.yml
```

### Log Patterns Observed

```
# No concrete log lines were included; only file paths were cited:
reports/ratchet/pipeline_*.log
reports/bleep_run_*.log
```

## Gaps Requiring Further Investigation

* Retrieve and attach actual `pytest` summary, coverage percentage from `coverage.xml`, and selected `bleep` log lines.
* Reconcile coverage (\~69%) vs gate (≥70%) pass status with CI artifacts.
* Provide the exact assertion and sanitation behavior for `test_resolve_topic_wildcard`.

## References

* **Source Files Examined (by path):** `coverage.xml`; `.github/workflows/shape.yml`; `.github/workflows/tests.yml`; `reports/ratchet/pipeline_*.log`; `reports/bleep_run_*.log`. (§2)
* **Commands Executed:** None shown with output in-session.
* **Tests Performed:** Narrative evidence of 200+ passing tests; 1 failing test `test_resolve_topic_wildcard`. (§1, §3)
* **Session Sections:** §1, §2, §3

---

**Extraction Date:** 28 Sep 2025
**Session ID/Reference:** BB8-STP5-MVP / trace-bb8-2f0c9e9a
**Evidence Quality:** Partial (requires validation)

````

---

```markdown
# ADR-2002: Deployment Topology & Operations (as observed)

**Session Evidence Source:** 
- §1 “Session Recap Summary” (Governance traits; Strategic posture)
- §2 “Artifact Reference Index”
- §3 “Phase + Output Registry”

## Context
Repository structure and CI controls were canonicalized; snapshot policy and backups are present. Real deployment to a target runtime was not executed in-session.

**Problem Statement:** Establish operational guardrails and artifacts enabling reversible changes and repository integrity.

**Investigation Method:** Review of session statements and artifact path inventory.

**Evidence Gathered:**
- Canonical code root set to `addon/`; root `bb8_core/` removed; imports canonicalized to `addon.bb8_core`. (§1)
- “Shape guard” present via `.github/workflows/shape.yml`. (§2)
- Snapshot policy and make targets present: `scripts/snapshot_policy.sh`, `scripts/snapshot.mk`; backups tracked under `_backups/`. (§2)
- Ratchet commits occur, but **push blocked** due to missing Git remote configuration. (§1)

## Decision
**Technical Choice:** 
- Enforce repo shape (canonical root `addon/`) via CI.
- Maintain snapshot artifacts for rollback posture.
- Defer automated pushes until a remote is configured.

**Command/Configuration:** 
- Paths: `.github/workflows/shape.yml`; `scripts/snapshot_policy.sh`; `scripts/snapshot.mk`; `_backups/.snapshot_state.json`; `_backups/wtree_*.tgz`. (§2)

**Validation Results:** 
- CI “shape guard” reported as active. (§1)
- Snapshots policy and targets listed; no execution transcript provided. (§2)

## Consequences

### Positive
- Guardrails prevent repo-shape regressions. (§1, §2)
- Snapshot evidence paths enable audit/rollback readiness. (§2)

### Negative
- Automation cannot push ratchet changes without a configured remote. (§1)

### Unknown/Untested
- No deployment receipts, SSH commands, or rollback drills were shown.

## Implementation Evidence

### Commands Verified
```bash
# None evidenced as executed in-session.
````

### Configuration Discovered

```yaml
# Files documented in-session (contents not pasted):
.github/workflows/shape.yml
scripts/snapshot_policy.sh
scripts/snapshot.mk
```

### Log Patterns Observed

```
# Not provided.
```

## Gaps Requiring Further Investigation

* Add/verify Git remote for CI push and capture a successful push log.
* Provide a snapshot creation/restore transcript demonstrating rollback.
* Supply the CI “shape” job logs confirming enforcement.

## References

* **Source Files (by path):** as above (§2).
* **Session Sections:** §1, §2, §3

---

**Extraction Date:** 28 Sep 2025
**Session ID/Reference:** BB8-STP5-MVP / trace-bb8-2f0c9e9a
**Evidence Quality:** Partial (requires validation)

````

---

```markdown
# ADR-2003: Container Supervision & Process Management (evidence status)

**Session Evidence Source:** 
- §1 “Session Recap Summary” (Repo shape notes)
- §2 “Artifact Reference Index”

## Context
The session mentions moving `services.d` and `tools` under `addon/` as part of repo canonicalization. No supervision scripts/config contents were shown.

**Problem Statement:** Identify concrete supervision/runtime controls (e.g., service definitions, health checks, restart semantics).

**Investigation Method:** Session recap review only; no code excerpts provided.

**Evidence Gathered:**
- “Removed root `bb8_core`, moved `services.d` & `tools` under `addon/`” (path-level evidence only). (§1)

## Decision
**Technical Choice:** None finalized—insufficient evidence to assert supervision mechanism or health check behavior.

**Command/Configuration:** N/A (not provided).

**Validation Results:** N/A.

## Consequences

### Positive
- Path consolidation suggests preparation for add-on style packaging.

### Negative
- Supervision behavior (restart strategy, health checks, signal handling) remains undocumented.

### Unknown/Untested
- Process manager (if any), service definitions, and lifecycle hooks not observed.

## Implementation Evidence

### Commands Verified
```bash
# None.
````

### Configuration Discovered

```
# Only path movement stated:
addon/services.d/   (contents not shown)
addon/tools/        (contents not shown)
```

### Log Patterns Observed

```
# None.
```

## Gaps Requiring Further Investigation

* Provide contents of any `services.d/*` files or equivalent supervisor configs.
* Show health check mechanisms and signal handling in code/scripts.
* Capture container restart policy and liveness/readiness checks if present.

## References

* **Session Sections:** §1, §2

---

**Extraction Date:** 28 Sep 2025
**Session ID/Reference:** BB8-STP5-MVP / trace-bb8-2f0c9e9a
**Evidence Quality:** Requires Validation

````

---

```markdown
# ADR-2004: Integration Architecture (MQTT/BLE/API) — Verified Session Findings

**Session Evidence Source:** 
- §1 “Session Recap Summary” (Unresolved blockers; Strategic posture)
- §3 “Phase + Output Registry” (P2 MQTT seam, P4 wildcard policy)
- §5 “Final Advisory” (policy posture & pending actions)

## Context
The session validated a FakeMQTT seam and identified a test-policy mismatch around MQTT topic wildcards. End-to-end motion over MQTT/BLE was not yet wired.

**Problem Statement:** Align MQTT topic policy with tests; confirm integration seam behavior without a real broker.

**Investigation Method:** Review of phase outcomes and blockers.

**Evidence Gathered:**
- P2 “MQTT seam (bleep)”: `addon/tools/bleep_run.py` with FakeMQTT; logs retained. (**Completed**). (§3)
- P4 “Wildcard policy”: Code sanitizes wildcard topics; old test expects wildcard to stay → **Blocked by outdated test**. (§3)
- Unresolved blockers: “Real MQTT/BLE parameters unknown; motion path not wired end-to-end yet.” (§1)

## Decision
**Technical Choice (verified by session statements):**
- **No MQTT wildcards**: inputs sanitized; policy enforced in code. (§3)
- **Integration seam via FakeMQTT** is the current validated path; real broker smoke pending secrets. (§3, §1)

**Command/Configuration:** 
- Tool path referenced: `addon/tools/bleep_run.py`. (§3)
- Failing test identifier: `test_resolve_topic_wildcard`. (§1)

**Validation Results:**
- FakeMQTT seam considered “proof-of-life” (logs exist, not pasted). (§2, §3)
- One failing test confirms policy/test mismatch on wildcard sanitation. (§1, §3)

## Consequences

### Positive
- Deterministic FakeMQTT testing path available and exercised. (§3)
- Clear policy stance against wildcards prevents hazardous subscriptions. (§3)

### Negative
- Test suite currently red due to `test_resolve_topic_wildcard`. (§1, §3)
- Real broker and BLE parameters unset; no E2E motion validation yet. (§1)

### Unknown/Untested
- Real-broker connectivity, authentication flow, and BLE command path.
- MQTT discovery entities for motion were discussed as a target but not shown as implemented.

## Implementation Evidence

### Commands Verified
```bash
# None shown; `bleep_run.py` existence and use were reported but outputs were not pasted.
````

### Configuration Discovered

```
# Paths referenced:
addon/tools/bleep_run.py
addon/tests/.../test_resolve_topic_wildcard (module path not fully provided in recap)
```

### Log Patterns Observed

```
# Not included; logs referenced by path: reports/bleep_run_*.log
```

## Gaps Requiring Further Investigation

* Capture and attach a FakeMQTT session transcript (connect, publish/subscribe traces).
* Provide the exact sanitation logic for wildcard topics and the updated test expectation.
* Document real-broker credentials handling and failure modes when secrets are absent.
* Confirm BLE adapter/device handling once parameters are provided.

## References

* **Source Files/Paths Mentioned:** `addon/tools/bleep_run.py`; `reports/bleep_run_*.log`. (§2, §3)
* **Tests Performed:** Policy mismatch surfaced via `test_resolve_topic_wildcard`. (§1, §3)
* **Session Sections:** §1, §3, §5

---

**Extraction Date:** 28 Sep 2025
**Session ID/Reference:** BB8-STP5-MVP / trace-bb8-2f0c9e9a
**Evidence Quality:** Partial (requires validation)

```

---

### Final Validation Checklist (applied)
- [x] Every technical detail is traceable to session statements/paths  
- [x] Commands/configs only included if cited in-session (no invented outputs)  
- [x] Gaps and unknowns explicitly called out  
- [x] No extrapolated behavior beyond session evidence  
- [x] References point to specific session sections and paths  
- [x] Evidence quality clearly labeled
```

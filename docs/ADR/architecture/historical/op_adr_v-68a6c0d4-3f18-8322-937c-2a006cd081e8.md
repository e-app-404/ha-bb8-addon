````markdown
# ADR-0001: Deployment Topology — Dual-Clone Canonicalization & Runtime Alignment

**Session Evidence Source:** Multiple logs and commands across the session, e.g.:
- “Confirmation” block with push + runtime reset and tokens (`243c989`), then release/tag (`9c31463`)
- Final governance receipt at `6e2e2e2`
- Duplicate-folder prune and runtime clean confirmations

## Context
- Workspace and runtime are separate git clones that must track the same remote.
- Historical symlinks and duplicated directories in `addon/` caused drift and ambiguity.

**Problem Statement:** Keep runtime and workspace aligned to a single remote; remove workspace-only directories from the add-on repository and runtime.

**Investigation Method:** Iterative deploys, hard resets, tokenized structure checks; directory tree comparisons; `.gitignore` guards; runtime inspection.

**Evidence Gathered:**
- Successful deploy sequences with consistent heads and emitted tokens:
  - Example:  
    ```
    DEPLOY_OK runtime_head=243c989 branch=main
    VERIFY_OK ws_head=243c989 runtime_head=243c989 remote=git@github.com:e-app-404/ha-bb8-addon.git
    STRUCTURE_OK
    WS_READY addon_ws=git_clone_ok runtime=git_clone_ok reports=ok wrappers=ok ops=ok
    ```
  - Final confirmation after pruning & clean:
    ```
    DEPLOY_OK runtime_head=6e2e2e2 branch=main
    VERIFY_OK ws_head=6e2e2e2 runtime_head=6e2e2e2 remote=git@github.com:e-app-404/ha-bb8-addon.git
    STRUCTURE_OK
    WS_READY addon_ws=git_clone_ok runtime=git_clone_ok reports=ok wrappers=ok ops=ok
    ```

## Decision
**Technical Choice:** Dual-clone model; deploy = push workspace → runtime `fetch + checkout -B <branch> origin/<branch> + reset --hard origin/<branch>`; prune workspace-only dirs from repo and runtime; guard via `.gitignore`.

**Command/Configuration:**
- Workspace push and runtime alignment (observed):
  ```bash
  git -C "$ADDON" push origin HEAD:main
  git -C "$RUNTIME" fetch --all --prune
  git -C "$RUNTIME" checkout -B main origin/main
  git -C "$RUNTIME" reset --hard origin/main
````

* `.gitignore` guards added in repo (observed):

  ```
  /docs/
  /ops/
  /reports/
  /scripts/
  /tools/
  /addon/
  /.github/
  ```

**Validation Results:**

* Heads match after each deploy; tokens consistently emitted.
* Final verification printed:

  ```
  [repo ok]
  [runtime ok]
  ```

## Consequences

### Positive

* Deterministic deployments (branch-based hard reset).
* Runtime drift eliminated after clean.
* Workspace-only directories blocked from re-entering repo.

### Negative

* Runtime edits are discarded by design unless explicitly promoted.
* Requires discipline to keep workspace-only assets out of `addon/`.

### Unknown/Untested

* Automated HA restart details not validated beyond “HA Restarted” message in script output.

## Implementation Evidence

### Commands Verified

```bash
git -C "/Users/evertappels/Projects/HA-BB8/addon" push origin HEAD:main
git -C "/Volumes/addons/local/beep_boop_bb8" fetch --all --prune
git -C "/Volumes/addons/local/beep_boop_bb8" checkout -B main origin/main
git -C "/Volumes/addons/local/beep_boop_bb8" reset --hard origin/main
git -C "/Users/evertappels/Projects/HA-BB8/addon" tag -a v2025.8.21 -m "Release 2025.8.21"
git -C "/Users/evertappels/Projects/HA-BB8/addon" push --tags
```

### Configuration Discovered

```yaml
# addon/config.yaml (observed line)
version: "2025.08.21"
```

### Log Patterns Observed

```
DEPLOY_OK runtime_head=<sha> branch=<branch>
VERIFY_OK ws_head=<sha> runtime_head=<sha> remote=git@github.com:e-app-404/ha-bb8-addon.git
STRUCTURE_OK
WS_READY addon_ws=git_clone_ok runtime=git_clone_ok reports=ok wrappers=ok ops=ok
```

## Gaps Requiring Further Investigation

* CI gate to enforce tokens on PRs (suggested; not shown executed here).
* Explicit HA restart mechanism (only “HA Restarted” message was observed).

## References

* **Commands Executed:** Multiple `git push`, `fetch`, `checkout -B`, `reset --hard`, `.gitignore` updates; final token emissions at `6e2e2e2`.
* **Tests Performed:** `pytest` run passing (see ADR-0002).
* **Session Sections:** “Confirmation” (push/reset/tokens), “Verification complete” (prune & guards), final governance receipt.

---

**Extraction Date:** 2025-09-28
**Session ID/Reference:** WS-RESTORE-ADDON-DUAL-CLONE (ws-restore-2025-08-21)
**Evidence Quality:** Complete

````

---

```markdown
# ADR-0002: Testing & Validation Protocol — Tokenized Structure Checks and Test Suite Gate

**Session Evidence Source:** Test and token outputs shown in multiple blocks, including final “All tests: PASSED” and emissions at `6e2e2e2`

## Context
- Need a simple, repeatable validation signaling mechanism to assert workspace and runtime health.
- Local test suite under `addon/tests/` must pass before deploy.

**Problem Statement:** Provide unambiguous acceptance signals and run tests prior to deployment.

**Investigation Method:** Executed `pytest` against `addon/tests`; emitted token lines from scripts; grepped logs.

**Evidence Gathered:**
- Passing test suite (explicit run):  
````

python3 -m pytest -q /Users/evertappels/Projects/HA-BB8/addon/tests/test_facade_attach_mqtt.py
python3 -m pytest -q /Users/evertappels/Projects/HA-BB8/addon/tests
...................                                                                                                               [100%]

````
- Token emissions captured in logs (examples shown in ADR-0001).

## Decision
**Technical Choice:** Use four banner tokens as binary gates: `STRUCTURE_OK`, `VERIFY_OK`, `WS_READY`, `DEPLOY_OK`. Require `pytest` green before push.

**Command/Configuration:**
```bash
python3 -m pytest -q "/Users/evertappels/Projects/HA-BB8/addon/tests"
grep -hE 'STRUCTURE_OK|VERIFY_OK|WS_READY|DEPLOY_OK' reports/{structure_check_run_*,verify_workspace_run_*}.log
````

**Validation Results:**

* “All tests: PASSED (virtual environment)” observed.
* Tokens printed in final verification sequences.

## Consequences

### Positive

* Clear, grep-friendly acceptance signals.
* Early detection of structural drift or runtime misalignment.

### Negative

* Tokens rely on scripts being present and called in order.
* No coverage threshold verified in-session (planned but not executed).

### Unknown/Untested

* CI enforcement of tokens (proposed but not shown executed).

## Implementation Evidence

### Commands Verified

```bash
python3 -m pytest -q "/Users/evertappels/Projects/HA-BB8/addon/tests"
bash "/Users/evertappels/Projects/HA-BB8/ops/audit/check_structure.sh"
bash "/Users/evertappels/Projects/HA-BB8/scripts/verify_workspace.sh"
```

### Log Patterns Observed

```
VERIFY_OK ws_head=6895825 runtime_head=3ed1339 remote=git@github.com:e-app-404/ha-bb8-addon.git
STRUCTURE_OK
```

## Gaps Requiring Further Investigation

* Add coverage reporting and minimum threshold; add token for coverage if desired.
* CI job to enforce tokens on PRs.

## References

* **Commands Executed:** `pytest`, `check_structure.sh`, `verify_workspace.sh` with log grep.
* **Tests Performed:** Full suite run showing all dots and 100% segment.
* **Session Sections:** “All tests: PASSED …” and earlier token grep blocks.

---

**Extraction Date:** 2025-09-28
**Session ID/Reference:** WS-RESTORE-ADDON-DUAL-CLONE
**Evidence Quality:** Complete

````

---

```markdown
# ADR-0003: Repository Hygiene — Prune Workspace-Only Dirs from Add-on Repo and Runtime

**Session Evidence Source:** Duplicate-folder analysis; prune commands and confirmations; `.gitignore` guards present

## Context
- Add-on repo contained folders intended only for local workspace use, causing clutter in runtime and confusion in repository.

**Problem Statement:** Ensure `addon/` contains only add-on assets (and `tests/`), excluding `docs/`, `ops/`, `reports/`, `scripts/`, `tools/`, nested `addon/`, and `.github/`.

**Investigation Method:** Directory listings; runtime inspections; `.gitignore` updates; verification loops.

**Evidence Gathered:**
- Final verification:
````

[repo ok]
[runtime ok]

````
- Confirmation: “No duplicate folders found … No tracked files remain in those folders … .gitignore guards are present.”

## Decision
**Technical Choice:** Remove workspace-only dirs from repo and runtime; add `.gitignore` guards to prevent reintroduction.

**Command/Configuration:**
```bash
git -C "$ADDON" rm -r --ignore-unmatch docs scripts tools reports addon .github
rm -rf "$ADDON"/{docs,scripts,tools,reports,addon,.github}
printf "\n/docs/\n/scripts/\n/tools/\n/reports/\n/addon/\n/.github/\n" >> "$ADDON/.gitignore"
git -C "$ADDON" push origin HEAD:main

rm -rf "$RUNTIME"/{docs,scripts,tools,reports,addon,.github}
git -C "$RUNTIME" clean -fdX
````

**Validation Results:**

* “No tracked duplicates” and guards verified; tokens printed post-clean.

## Consequences

### Positive

* Cleaner repository and runtime; reduced operational ambiguity.
* Hard guardrails via `.gitignore`.

### Negative

* Any prior reliance on those dirs inside add-on repo must move to workspace root.

### Unknown/Untested

* CI precommit/PR guards suggested later; not shown executed here.

## Implementation Evidence

### Log Patterns Observed

```
[ok] no tracked workspace-only files
[ok] gitignore guards present
[ok] runtime clean
```

## Gaps Requiring Further Investigation

* Enforce via CI hooks (proposed), not validated here.

## References

* **Commands Executed:** The prune, guard, and clean commands above.
* **Session Sections:** “Verification complete” and earlier prune discussion.

---

**Extraction Date:** 2025-09-28
**Session ID/Reference:** WS-RESTORE-ADDON-DUAL-CLONE
**Evidence Quality:** Complete

````

---

```markdown
# ADR-0004: Integration Architecture — Resolution of `publish_discovery` kwarg mismatch

**Session Evidence Source:** Pytest error and subsequent clean test run

## Context
- During tests, an integration mismatch surfaced between call sites and function signature for discovery publishing.

**Problem Statement:** `publish_discovery()` rejected an unexpected keyword argument `dbus_path` when called indirectly via `BB8Facade.attach_mqtt`.

**Investigation Method:** Ran targeted tests; inspected stack trace to pinpoint failing call.

**Evidence Gathered:**
- Failing test output:
````

E   TypeError: publish_discovery() got an unexpected keyword argument 'dbus_path'

```
with trace: `addon/tests/test_facade_attach_mqtt.py` → `addon/bb8_core/facade.py:293` → `publish_discovery(...)`
- Subsequent run showed full suite pass after conflict resolution and cleanup:
```

python3 -m pytest -q /Users/evertappels/Projects/HA-BB8/addon/tests
...................                                                                                                               [100%]

````

## Decision
**Technical Choice:** Align `publish_discovery` usage with its accepted parameters (exact code changes not shown in-thread), ensuring `attach_mqtt` path no longer passes an unsupported kwarg.

**Command/Configuration:**
- No config changes observed; the validation was through tests.

**Validation Results:**
- Targeted test and full suite passed after resolution.

## Consequences

### Positive
- Eliminates runtime TypeError in discovery publication paths.
- Test coverage caught the mismatch; regression signal in place.

### Negative
- None observed in-session.

### Unknown/Untested
- Broader discovery behavior and message schemas not validated here.

## Implementation Evidence

### Commands Verified
```bash
python3 -m pytest -q /Users/evertappels/Projects/HA-BB8/addon/tests/test_facade_attach_mqtt.py
python3 -m pytest -q /Users/evertappels/Projects/HA-BB8/addon/tests
````

### Log Patterns Observed

```
TypeError: publish_discovery() got an unexpected keyword argument 'dbus_path'
...................                                                                                                               [100%]
```

## Gaps Requiring Further Investigation

* Formal schema and topic validation for discovery messages (not executed in this session).
* Evidence artifacts for strict STP4 run (pending).

## References

* **Source Files Mentioned:** `addon/bb8_core/facade.py` (call site), `addon/tests/test_facade_attach_mqtt.py` (failing test)
* **Tests Performed:** The two pytest invocations above.
* **Session Sections:** Error report and subsequent passing test run.

---

**Extraction Date:** 2025-09-28
**Session ID/Reference:** WS-RESTORE-ADDON-DUAL-CLONE
**Evidence Quality:** Partial (behavior validated by tests; diff not shown)

````

---

```markdown
# ADR-0005: Remote Connectivity & Git Hygiene — SSH, Orphan HEAD, and Rebase Conflict Handling

**Session Evidence Source:** Connectivity check output; push errors; rebase conflict report and resolution

## Context
- Ensuring remote reachability and healthy branch refs is critical to deterministic deployments.

**Problem Statement:** Validate remote SSH access; resolve orphan `HEAD` branch creation and `.gitignore` rebase conflict.

**Investigation Method:** SSH-based `git ls-remote` connectivity test; observed push errors; resolved rebase conflicts.

**Evidence Gathered:**
- Remote reachability:
````

GIT_TERMINAL_PROMPT=0 GIT_SSH_COMMAND='ssh -o BatchMode=yes -o StrictHostKeyChecking=accept-new -o ConnectTimeout=15' 
git ls-remote "[git@github.com](mailto:git@github.com):e-app-404/ha-bb8-addon.git" >/dev/null && echo "[ok] remote reachable"
[ok] remote reachable

```
- Push error creating orphan HEAD (earlier):
```

error: The destination you provided is not a full refname ...
fatal: 'HEAD' is not a valid branch name

````
- Rebase conflict in `.gitignore` (reported and resolved by union merge).

## Decision
**Technical Choice:** Always qualify refspecs when pushing; resolve `.gitignore` conflicts by unioning rulesets to retain Python/HA/build ignores plus Node/macos/.env ignores.

**Command/Configuration:**
```bash
git -C "$ADDON" push origin HEAD:main
git -C "$ADDON" rebase origin/main   # conflict resolved by merging both ignore rule sets
````

**Validation Results:**

* Subsequent pushes and fetch/resets succeeded; tokens emitted.

## Consequences

### Positive

* Stable remote ops; minimized interaction prompts; safer non-interactive scripts.
* `.gitignore` robust to common local artifacts.

### Negative

* None observed.

### Unknown/Untested

* None documented beyond these cases.

## Implementation Evidence

### Commands Verified

```bash
GIT_TERMINAL_PROMPT=0 GIT_SSH_COMMAND='ssh -o BatchMode=yes -o StrictHostKeyChecking=accept-new -o ConnectTimeout=15' git ls-remote "git@github.com:e-app-404/ha-bb8-addon.git"
git -C "/Users/evertappels/Projects/HA-BB8/addon" rebase origin/main
git -C "/Users/evertappels/Projects/HA-BB8/addon" push origin HEAD:main
```

### Log Patterns Observed

```
[ok] remote reachable
error: The destination you provided is not a full refname ...
fatal: 'HEAD' is not a valid branch name
```

## Gaps Requiring Further Investigation

* None flagged for this topic.

## References

* **Commands Executed:** Connectivity test, rebase, push.
* **Session Sections:** Connectivity `[ok]`, orphan HEAD error, rebase conflict narrative.

---

**Extraction Date:** 2025-09-28
**Session ID/Reference:** WS-RESTORE-ADDON-DUAL-CLONE
**Evidence Quality:** Complete

```

---

## Final Validation Checklist

- [x] Every detail above is tied to session logs/commands or explicit descriptions  
- [x] No invented procedures; unknowns are called out  
- [x] Decisions reflect what was actually executed/validated  
- [x] References are specific to the observed content
```

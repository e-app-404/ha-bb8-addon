````markdown
# ADR-0012: Supervisor-only Testing & Validation Protocol

**Session Evidence Source:** 
- “Verification results (HA Host)” and subsequent DIAG/heartbeat snapshots (multiple messages dated 2025-09-02 .. 2025-09-03).
- “Supervisor-only verification block (run on HA host)” and returned outputs.
- “Final verification results — Supervisor logs only.”

## Context
The add-on container was confirmed running and logging, but was not visible via `docker ps`. Diagnostics therefore had to use the Home Assistant Supervisor CLI (`ha`) and Supervisor logs only.

**Problem Statement:** Validate runtime health, respawn behavior, and MQTT connectivity without relying on `docker exec/ps`.

**Investigation Method:** Supervisor-only CLI commands (`ha addons info|options|logs`, `ha service call`), examination of emitted DIAG lines and heartbeat summaries in Supervisor logs.

**Evidence Gathered:**
- DIAG lines observed in Supervisor logs:
  - `run.sh entry`, `RUNLOOP attempt #N`, `Started bb8_core.main PID=…`, `Started bb8_core.echo_responder PID=…`, `Child exited: dead=…`, `HEALTH_SUMMARY main_age=… echo_age=… interval=15s`.  
    *(e.g., “2025-09-02T22:00:36+01:00 [BB-8] run.sh entry …”, “RUNLOOP attempt #1”, “Started bb8_core.main PID=131”, “Child exited: dead=echo_responder.py(134) exit_code=143 …”, repeated HEALTH_SUMMARY lines at 15s cadence)*
- Heartbeat snapshots showed changing ages over time (e.g., `main_age=4.1s echo_age=4.1s`).
- MQTT connectivity confirmed via logs: `Connected to MQTT broker with rc=Success`, `Subscribed to bb8/echo/cmd`.

## Decision
**Technical Choice:** Adopt Supervisor-only validation protocol driven by `ha` CLI and log inspection.

**Command/Configuration:** The following commands were executed and produced expected results in session:
```bash
# Add-on state & version
ha addons info local_beep_boop_bb8 | jq -r '.state+" @ "+.version'

# Options slice (materialized config)
ha addons options local_beep_boop_bb8 | jq -c '{enable_echo,enable_health_checks,log_path,mqtt_host,mqtt_port}'

# DIAG lines
ha addons logs local_beep_boop_bb8 --lines 400 \
  | grep -E 'run.sh entry|RUNLOOP attempt|Started bb8_core.(main|echo_responder) PID|Child exited|HEALTH_SUMMARY'

# Heartbeat snapshots (~15s apart)
echo '--- A ---'; ha addons logs local_beep_boop_bb8 --lines 200 | grep HEALTH_SUMMARY | tail -n 3
sleep 15
echo '--- B ---'; ha addons logs local_beep_boop_bb8 --lines 200 | grep HEALTH_SUMMARY | tail -n 3

# MQTT smoke test (observed working in session)
ha service call mqtt.publish -d '{"topic":"bb8/echo/cmd","payload":"{\"value\":\"ping\"}"}'
````

**Validation Results:**

* PASS: DIAG/HEALTH\_SUMMARY present and ticking at 15s.
* PASS: Heartbeat ages change between snapshots.
* PASS: MQTT connected/subscribed lines appear after publish.

## Consequences

### Positive

* Repeatable, environment-agnostic checks using only Supervisor interfaces.
* Clear acceptance tokens visible in logs without container access.

### Negative

* Fine-grained process inspection (`ps`, `pkill`) unavailable in this mode.

### Unknown/Untested

* No explicit RTT telemetry trending validated in this session.

## Implementation Evidence

### Commands Verified

See command block above; outputs with PASS markers were posted in-session.

### Configuration Discovered

```json
{"enable_echo":true,"enable_health_checks":true,"log_path":"/data/reports/ha_bb8_addon.log","mqtt_host":"192.168.0.129","mqtt_port":1883}
```

### Log Patterns Observed

```
[BB-8] run.sh entry (version=unknown) wd=/usr/src/app LOG=/data/reports/ha_bb8_addon.log HEALTH=1 ECHO=true
[BB-8] RUNLOOP attempt #1
[BB-8] Started bb8_core.main PID=131
[BB-8] Started bb8_core.echo_responder PID=134
[BB-8] Child exited: dead=echo_responder.py(134) exit_code=143 (main=131 echo=134)
[BB-8] HEALTH_SUMMARY main_age=4.1s echo_age=4.1s interval=15s
Connected to MQTT broker with rc=Success
Subscribed to bb8/echo/cmd
```

## Gaps Requiring Further Investigation

* No end-to-end BLE action tests (beyond adapter presence and init logs) captured here.

## References

* **Source Files Examined:** `addon/run.sh`, `addon/services.d/ble_bridge/run`, `addon/services.d/echo_responder/down`, `addon/bb8_core/main.py`, `addon/bb8_core/echo_responder.py`, `addon/config.yaml`.
* **Commands Executed:** `ha addons info|options|logs`, `ha service call mqtt.publish …` (see above).
* **Tests Performed:** DIAG/heartbeat cadence snapshots; MQTT smoke.
* **Session Sections:** “Supervisor-only verification block …” and subsequent Operator outputs containing the quoted logs.

---

**Extraction Date:** 2025-09-03
**Session ID/Reference:** HANDOFF::STRATEGOS::HA-BB8::2025-09-03T06:50Z-001
**Evidence Quality:** Complete

````

---

```markdown
# ADR-0013: Deployment Topology & Operations

**Session Evidence Source:** 
- “make release-patch” outputs with BUMP_OK / SUBTREE_PUBLISH_OK / DEPLOY_OK tokens.
- Rsync receipts showing `/addons/local/beep_boop_bb8` sync and matching SHA256 of `config.yaml`.
- Supervisor logs showing build, update, and start of image `local/aarch64-addon-beep_boop_bb8:2025.8.21.28`.

## Context
A release pipeline was exercised from the local repo to the HA host, publishing an addon subtree and deploying via SSH and Supervisor API.

**Problem Statement:** Ensure reliable build/publish/deploy of add-on and runtime synchronization of `config.yaml`.

**Investigation Method:** Running release pipeline commands; verifying printed tokens; confirming rsync and SHA256 matches; observing Supervisor build/start logs.

**Evidence Gathered:**
- `make release-patch` printed:
  - `BUMP_OK:<version>`
  - `SUBTREE_PUBLISH_OK:main@<sha>`
  - `DEPLOY_OK — runtime rsync complete`
  - `VERIFY_OK — add-on restarted via Services API`
- Rsync to `/addons/local/beep_boop_bb8` and `LOCAL/REMOTE config.yaml sha256=<same hash>`.
- Supervisor log lines:
  - `Starting build for local/aarch64-addon-beep_boop_bb8:2025.8.21.28`
  - `Add-on 'local_beep_boop_bb8' successfully updated`
  - `Starting Docker add-on local/aarch64-addon-beep_boop_bb8 with version 2025.8.21.28`

## Decision
**Technical Choice:** Adopt one-command release via `make release-patch` and associated scripts.

**Command/Configuration:**
```bash
make release-patch
# (internally calls)
ops/workspace/publish_addon_archive.sh
ops/release/deploy_ha_over_ssh.sh
````

**Validation Results:**

* PASS: Version bump + subtree publish tokens printed.
* PASS: Rsync completed; `config.yaml` SHA256 matched on host.
* PASS: Supervisor built and started the new image; add-on state `started`.

## Consequences

### Positive

* Deterministic, idempotent release flow with explicit success tokens.
* Post-deploy verification baked in (Supervisor restart + logs).

### Negative

* Pipeline assumes HA host SSH reachability and correct credentials.

### Unknown/Untested

* Rollback not exercised in session (no `make release-rollback` observed).

## Implementation Evidence

### Commands Verified

```
make release-patch
# Tokens observed: BUMP_OK, SUBTREE_PUBLISH_OK, DEPLOY_OK, VERIFY_OK
# Rsync path: /addons/local/beep_boop_bb8
# SHA256 of config.yaml matched: fab7eeb5… / f0793e55…
```

### Configuration Discovered

* Add-on slug: `local_beep_boop_bb8`
* Image tags updated to `2025.8.21.28` (Supervisor logs)

### Log Patterns Observed

```
[supervisor.docker.addon] Starting build for local/aarch64-addon-beep_boop_bb8:2025.8.21.28
[supervisor.addons.addon] Add-on 'local_beep_boop_bb8' successfully updated
[supervisor.docker.addon] Starting Docker add-on local/aarch64-addon-beep_boop_bb8 with version 2025.8.21.28
```

## Gaps Requiring Further Investigation

* Define/validate a rollback procedure and acceptance tokens (not executed here).

## References

* **Source Files Examined:** `Makefile`, `ops/workspace/publish_addon_archive.sh`, `ops/release/deploy_ha_over_ssh.sh`, `addon/config.yaml`.
* **Commands Executed:** `make release-patch`, rsync receipts in session outputs.
* **Tests Performed:** Deploy+restart verification via Supervisor logs.

---

**Extraction Date:** 2025-09-03
**Session ID/Reference:** HANDOFF::STRATEGOS::HA-BB8::2025-09-03T06:50Z-001
**Evidence Quality:** Complete

````

---

```markdown
# ADR-0014: Container Supervision & Process Management

**Session Evidence Source:**
- File reads of `addon/services.d/ble_bridge/run` and presence of `addon/services.d/echo_responder/down`.
- `addon/run.sh` behavior verified via logs.
- DIAG lines evidencing child start/exit and respawn.

## Context
A single control-plane was required with `run.sh` supervising Python children. S6 supervision for `echo_responder` was disabled to prevent dual control.

**Problem Statement:** Prevent supervision conflicts; provide clear DIAG for start/exit/respawn; enable health checks.

**Investigation Method:** Code/structure inspection and observing emitted logs during start, kill, and respawn drills.

**Evidence Gathered:**
- `services.d/ble_bridge/run`:
````

\#!/usr/bin/with-contenv bash
set -euo pipefail
cd /usr/src/app
exec /usr/bin/env bash /usr/src/app/run.sh

```
- `services.d/echo_responder/down`: *(present)* — disables s6 longrun.
- `run.sh` emitted:
- `run.sh entry …`
- `RUNLOOP attempt #1`
- `Started bb8_core.main PID=…`
- `Started bb8_core.echo_responder PID=…`
- `Child exited: dead=… exit_code=…`
- `HEALTH_SUMMARY main_age=… echo_age=… interval=15s`
- Heartbeats written by Python to `/tmp/bb8_heartbeat_main` and `/tmp/bb8_heartbeat_echo`.

## Decision
**Technical Choice:** Single runloop in `run.sh` supervises children; s6 echo_responder kept DOWN.

**Command/Configuration:**
- Supervision files:
- `addon/services.d/ble_bridge/run` → delegates to `run.sh`
- `addon/services.d/echo_responder/down` → ensures s6 does not spawn `echo_responder`
- Health checks enabled via options (observed `enable_health_checks: true`), resulting in heartbeat files and `HEALTH_SUMMARY` lines at 15s cadence.

**Validation Results:**
- PASS: Child start/exit events logged.
- PASS: Respawn attempts logged (`RUNLOOP attempt #N`).
- PASS: Heartbeats observed and summarized.

## Consequences

### Positive
- No dual supervision; clean, readable DIAG lines.
- Health/liveness visibility without in-container tooling.

### Negative
- Manual halt (`/tmp/bb8_restart_disabled`) requires container context; not used in Supervisor-only ops.

### Unknown/Untested
- Different `RESTART_LIMIT` values beyond observed defaults not exercised in final runs; earlier logs showed the “RESTART_LIMIT reached …” pathway in prior attempts.

## Implementation Evidence

### Configuration Discovered
```

addon/services.d/ble\_bridge/run        # delegates to run.sh
addon/services.d/echo\_responder/down   # present

```

### Log Patterns Observed
```

\[BB-8] run.sh entry …
\[BB-8] RUNLOOP attempt #1
\[BB-8] Started bb8\_core.main PID=…
\[BB-8] Started bb8\_core.echo\_responder PID=…
\[BB-8] Child exited: dead=echo\_responder.py(134) exit\_code=143 (main=131 echo=134)
\[BB-8] HEALTH\_SUMMARY main\_age=4.1s echo\_age=4.1s interval=15s

```

## Gaps Requiring Further Investigation
- Explicit end-to-end test of `/tmp/bb8_restart_disabled` behavior not reproduced in the final Supervisor-only flow.

## References
- **Source Files Examined:** `addon/run.sh`, `addon/services.d/ble_bridge/run`, `addon/services.d/echo_responder/down`.
- **Tests Performed:** Kill/respawn observations via Supervisor logs; heartbeat summaries at 15s.

---
**Extraction Date:** 2025-09-03  
**Session ID/Reference:** HANDOFF::STRATEGOS::HA-BB8::2025-09-03T06:50Z-001  
**Evidence Quality:** Complete (with noted minor gap on manual halt flag in final flow)
```

---

````markdown
# ADR-0015: Integration Architecture (MQTT & BLE)

**Session Evidence Source:**
- `addon/bb8_core/echo_responder.py` code excerpts posted.
- Supervisor logs showing MQTT connection and subscription.
- Add-on options slice showing broker host/port and credentials keys.
- Add-on info showing `/dev/hci0` device mapping and BLE adapter logs.

## Context
The add-on integrates via MQTT for command/telemetry and uses BLE (via `bleak`) to interact with Sphero BB-8.

**Problem Statement:** Document observed connection/auth patterns and hardware prerequisites as implemented.

**Investigation Method:** Code inspection; options materialization; runtime log review.

**Evidence Gathered:**
- MQTT client creation using Paho v2 enum:
  ```python
  from paho.mqtt.enums import CallbackAPIVersion
  client = mqtt.Client(callback_api_version=CallbackAPIVersion.VERSION2)
````

* Observed logs:

  ```
  Connected to MQTT broker with rc=Success
  Subscribed to bb8/echo/cmd
  ```
* Options materialized at runtime (excerpt):

  ```json
  {"enable_echo":true,"enable_health_checks":true,"log_path":"/data/reports/ha_bb8_addon.log","mqtt_host":"192.168.0.129","mqtt_port":1883}
  ```
* BLE evidence:

  * Add-on device mapping includes `/dev/hci0`.
  * Logs show: `{'event': 'ble_gateway_init', 'mode': 'bleak', 'adapter': 'hci0'}` and `'core_init', 'address': 'ED:ED:87:D7:27:50'`.

## Decision

**Technical Choice:**

* MQTT: Use Paho MQTT with v2 enums; connect to configured broker host/port; subscribe to `bb8/echo/cmd`; publish telemetry/acks as per code.
* BLE: Use `bleak` with adapter `hci0` and configured/derived device address.

**Command/Configuration:**

* MQTT smoke used in-session:

```bash
ha service call mqtt.publish -d '{"topic":"bb8/echo/cmd","payload":"{\"value\":\"ping\"}"}'
```

* Device mapping (from add-on info):

```
devices:
- /dev/hci0
```

**Validation Results:**

* PASS: MQTT connect+subscribe lines present in logs post-publish.
* PASS: BLE gateway init logged with adapter `hci0`.

## Consequences

### Positive

* Clear broker connectivity evidenced; command channel verified.
* BLE adapter presence validated at startup.

### Negative

* End-to-end BLE actuation (beyond init) not captured in session outputs.

### Unknown/Untested

* TLS MQTT configuration and credential edge cases not exercised in logs shared.

## Implementation Evidence

### Configuration Discovered

```json
{"mqtt_host":"192.168.0.129","mqtt_port":1883,"enable_echo":true}
```

### Log Patterns Observed

```
Connected to MQTT broker with rc=Success
Subscribed to bb8/echo/cmd
{'event': 'ble_gateway_init', 'mode': 'bleak', 'adapter': 'hci0'}
```

## Gaps Requiring Further Investigation

* BLE write/notify success paths and latency metrics not evidenced here.
* Authentication variations (user/pass vs anonymous, TLS) not tested.

## References

* **Source Files Examined:** `addon/bb8_core/echo_responder.py`, runtime options via Supervisor.
* **Commands Executed:** `ha service call mqtt.publish …` (see above).
* **Session Sections:** Logs and options slices posted by Operator.

---

**Extraction Date:** 2025-09-03
**Session ID/Reference:** HANDOFF::STRATEGOS::HA-BB8::2025-09-03T06:50Z-001
**Evidence Quality:** Partial (MQTT/BLE init verified; deeper paths pending)

```

---

## Final Validation Checklist (Applied)

- [x] Every technical detail mapped to session evidence  
- [x] Commands/configurations actually observed or executed  
- [x] Gaps and unknowns explicitly listed  
- [x] No invented details; supervision & ops match logs/files  
- [x] References point to specific session outputs and file paths  
- [x] Evidence quality marked per ADR

```

# ════════════════════════════════════════════════════════════════
# ▶ INTEGRATION: Command Line Sensors ◀
# File: /config/domain/shell_commands/git_push_logger.sh
# Loader: packages  •  Domain: integration  •  Last Updated: 2025-08-06
# ════════════════════════════════════════════════════════════════

command_line:
  - binary_sensor:
      name: Git Repo Synced with DSM
      unique_id: cli_git_repo_synced_dsm_alpha
      device_class: connectivity
      command: >-
        bash -lc '
          set -eo pipefail
          REMOTE=$(ssh -F /config/.ssh/config dsm-git-host "git --git-dir=/volume1/HA_MIRROR for-each-ref --format=%(objectname:short) refs/heads/main" 2>/dev/null || true);
          LOCAL=$(git -C /config rev-parse --short HEAD 2>/dev/null || true);
          if [ -n "$REMOTE" ] && [ -n "$LOCAL" ] && [ "$REMOTE" = "$LOCAL" ]; then echo on; else echo off; fi
        '
      scan_interval: 120
      command_timeout: 20

  - sensor:
      name: "DSM Git Repo Latest Commit"
      unique_id: cli_dsm_git_commit_hash_alpha
      command: >-
        bash -lc '
          set -eo pipefail
          ssh -F /config/.ssh/config dsm-git-host "git --git-dir=/volume1/HA_MIRROR for-each-ref --format=%(objectname:short) refs/heads/main" 2>/dev/null || echo unknown
        '
      scan_interval: 120
      command_timeout: 20

  - binary_sensor:
      name: "DSM Git Latest Commit Message"
      unique_id: cli_dsm_git_commit_message_alpha
      command: >-
        bash -lc '
          set -eo pipefail
          ssh -F /config/.ssh/config dsm-git-host "git --git-dir=/volume1/HA_MIRROR show -s --format=%s refs/heads/main" 2>/dev/null || echo unknown
        '
      scan_interval: 600
      command_timeout: 20

  - sensor:
      name: "Local Git Repo Commit Hash"
      unique_id: cli_local_git_commit_hash_alpha
      command: >-
        bash -lc '
          set -eo pipefail
          git -C /config rev-parse --short HEAD 2>/dev/null || echo unknown
        '
      scan_interval: 120
      command_timeout: 20

---
# HA BB8 Addon Diagnostician — promptset v1.0 (adapted from hass_diagnostician)
# Purpose: Structured promptset for diagnosing HA BB8 addon issues: MQTT discovery, BLE integration, Docker builds, and runtime failures.
promptset:
  id: ha-bb8-addon.diagnostician.v1.0
  version: 1.0
  created: "2025-10-04"
  description: |
    Diagnostician for HA BB8 Home Assistant addon configuration, MQTT discovery, BLE integration,
    and container runtime issues. Guides evidence collection, structured analysis, and safe 
    corrective actions following ADR governance. Produces reproducible findings and reversible 
    remediation steps with clear confidence scoring.
  persona: bb8_addon_diagnostician
  purpose: |
    Use this promptset to analyze BB8 addon MQTT discovery payloads, BLE bridge failures,
    Docker container build issues, Python import/runtime errors, and Home Assistant integration
    lifecycle problems. Prioritize evidence from logs and config, avoid speculation, and produce
    small, reversible fixes with validation criteria following ADR patterns.
  schema_version: 1.0

  artifacts:
    required:
      - path: addon/config.yaml
      - path: addon/Dockerfile
      - path: addon/run.sh
    optional:
      - path: ops/scratch/*.log                    # HA error logs
      - path: reports/checkpoints/INT-HA-CONTROL/* # Evidence artifacts
      - path: addon/bb8_core/*.py                  # Core modules
      - path: addon/secrets.yaml                   # LLAT tokens
      - path: .env                                 # Environment config
      - path: logs/ha_bb8_addon.log               # Addon runtime logs

  bindings:
    protocols:
      - evidence_first
      - adr_compliance
      - no_unsafe_changes  
      - confidence_scoring
      - version_provenance
    persona: bb8_addon_diagnostician

  retrieval_tags:
    - bb8_addon
    - mqtt_discovery
    - ble_integration
    - docker_container
    - home_assistant
    - sphero_bb8

  operational_modes:
    - triage
    - deep_analysis
    - remediation

  prompts:
    - id: bb8.diagnostician.triage
      label: "Triage — Evidence collection & BB8 addon classification"
      persona: bb8_addon_diagnostician
      mode: triage
      protocols:
        - evidence_first
        - confidence_scoring
        - adr_compliance
      bindings:
        - addon/config.yaml
        - ops/scratch/*.log
        - addon/run.sh
      prompt: |
        BB8 ADDON DIAGNOSTIC MODE ENGAGED

        Step 0 — Verify inputs are present. If any required artifact is missing, respond with a concise list of missing items and exactly what to supply next.

        Step 1 — Collect minimal evidence: error timestamps, addon version, affected subsystem (mqtt/ble/docker/python), log excerpts, and relevant config fragments. Return a structured YAML block under the key `evidence:` containing these fields.

        Step 2 — Classify issue type:
        - subsystem: [mqtt_discovery|ble_bridge|docker_build|python_runtime|ha_integration|config_validation]
        - severity: [low|medium|high|critical] 
        - deployment_impact: [local_dev|supervisor|production]
        - adr_relevance: [list of relevant ADR numbers]
        - one-line rationale

        Step 3 — Check for known patterns:
        - Empty device blocks in MQTT discovery (ADR-0037)
        - Alpine vs Debian package manager conflicts (ADR-0008)
        - BLE adapter permission issues (ADR-0034)
        - Import path violations (ADR-0012)
        - Version provenance gaps (ADR-0040)

        Output: YAML block with keys `evidence`, `classification`, `known_patterns`, and `followup` (if more data needed).

        END: CONFIDENCE ASSESSMENT: [n]%

    - id: bb8.diagnostician.analysis
      label: "Deep analysis — BB8 addon dependency tracing & root cause"
      persona: bb8_addon_diagnostician
      mode: deep_analysis
      protocols:
        - evidence_first
        - adr_compliance
        - no_unsafe_changes
      bindings:
        - addon/bb8_core/*.py
        - reports/checkpoints/INT-HA-CONTROL/*
        - .env
      prompt: |
        Use the collected `evidence:` block from triage as input. Run the following BB8-specific pipeline:

        1) Pattern match logs and config against known BB8 failure signatures:
           - MQTT discovery device validation errors
           - Docker base image mismatches (Alpine vs Debian)
           - BLE adapter access failures
           - Python import/module resolution issues
           - LLAT token authentication problems
           
        2) Trace BB8 addon dependency chain:
           - Container: Dockerfile → base image → package manager → Python environment
           - Runtime: run.sh → bb8_core.main → MQTT dispatcher → BLE bridge
           - Integration: MQTT broker → HA Core → entity registry → device blocks
           - Config: .env → addon/config.yaml → secrets.yaml → runtime options
           
        3) Isolate earliest observable trigger and explain why alternate hypotheses are less likely.
        
        4) Cross-reference with ADR compliance:
           - ADR-0008: End-to-end flow violations
           - ADR-0037: Device block compliance issues  
           - ADR-0040: Version provenance gaps
           - ADR-0041: Configuration management problems

        Output: YAML with keys `dependency_chain`, `root_cause`, `alternatives_considered`, `adr_violations`, `evidence_lines`.

        END: CONFIDENCE ASSESSMENT: [n]%

    - id: bb8.diagnostician.remediation
      label: "Remediation — atomic, reversible BB8 addon fixes"
      persona: bb8_addon_diagnostician
      mode: remediation
      protocols:
        - no_unsafe_changes
        - confidence_scoring
        - adr_compliance
        - version_provenance
      bindings:
        - addon/config.yaml
        - addon/Dockerfile
        - addon/bb8_core/*.py
      prompt: |
        Given the `root_cause` and `dependency_chain`, propose up to three candidate fixes ranked by confidence.
        
        BB8 Addon Remediation Patterns:
        - MQTT Discovery: Add proper device blocks with identifiers/connections
        - Docker Build: Fix package manager commands (apk vs apt-get) 
        - BLE Integration: Correct adapter permissions and device access
        - Python Runtime: Fix import paths and module resolution
        - Configuration: Update .env and config.yaml consistency

        For each candidate, provide the following structured fields:
        - id: short-id
        - description: plain-language explanation
        - change: a patch-style minimal change (code fragment, config diff, or Dockerfile fix)
        - rollback: exact steps to revert
        - validation: concrete validation commands and expected results
        - adr_compliance: which ADRs this fix follows
        - testing: INT-HA-CONTROL validation steps if applicable
        - risk: low/medium/high
        - confidence: numeric percent

        Only include fixes that are atomic, reversible, and ADR-compliant. If confidence < 80%, request additional evidence instead of prescribing a change.

        Mandatory validation patterns:
        - MQTT fixes: Test with `./ops/release/deploy_ha_over_ssh.sh diagnose`
        - Docker fixes: Local build test with `docker build -t test .`
        - Config fixes: Validate with version provenance per ADR-0040
        - Python fixes: Import and syntax validation in venv

        Output: YAML list `fix_candidates:` with the fields above.

        END: CONFIDENCE ASSESSMENT: [n]%

  migration:
    strategy: |
      Preserve existing diagnostic artifacts in reports/ by mapping them to `evidence` and 
      `alternatives_considered` fields. Maintain ADR traceability in all remediation candidates.

  documentation:
    - Reference: /docs/ADR/ (all ADRs for compliance checking)
    - Guidance: Follow ADR-0009 formatting for any generated patches
    - Testing: Use INT-HA-CONTROL framework for operational validation

  operational_rules:
    - Never make live changes to addon code without version provenance (ADR-0040)
    - Always cite specific log lines, config fragments, or ADR sections
    - Prefer smallest possible change following single-responsibility principle
    - All Docker/container changes must be tested in LOCAL_DEV mode first
    - MQTT discovery fixes must include proper device block compliance (ADR-0037)
    - Configuration changes must update both .env and relevant config files
    - Tag confidence numerically on every major output block

  outputs:
    - name: bb8_diagnostics_report.yaml
      description: Structured BB8 addon diagnostic report with evidence, analysis, and remediation
      required: true
    - name: addon_fix.patch
      description: Minimal patch diff for chosen remediation candidate
      required: false
    - name: validation_checklist.md
      description: Step-by-step validation commands and expected results
      required: false

  bb8_specific_patterns:
    mqtt_discovery_errors:
      - empty_device_blocks: "device: {}"
      - missing_identifiers: "Device must have at least one identifying value"
      - invalid_device_format: "dictionary value @ data['device']"
    
    docker_build_errors:
      - wrong_package_manager: "/bin/ash: apt-get: not found"
      - base_image_mismatch: "Alpine base with Debian commands"
      - missing_dependencies: "python3: not found"
    
    ble_integration_errors:
      - adapter_permissions: "hci0: Permission denied"
      - bluetooth_service: "bluetoothd: not running"
      - device_not_found: "BB-8 device discovery failed"
    
    python_runtime_errors:
      - import_path_violations: "ModuleNotFoundError: No module named 'bb8_core'"
      - addon_prefix_missing: "Import should use 'addon.bb8_core'"
      - circular_imports: "ImportError: cannot import name"

  version_compliance:
    required_provenance:
      - addon_version: "addon/config.yaml version field"
      - git_commit: "Git commit hash for code traceability" 
      - deployment_method: "Supervisor vs standalone deployment"
      - test_artifacts: "INT-HA-CONTROL validation results"
---
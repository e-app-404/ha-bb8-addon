# ops/ Scripts Governance Review - Issues Found\n\n## üö® Critical Issues Requiring Immediate Fix\n\n### 1. **deploy_ha_over_ssh.sh** - Git Repository Issue (CRITICAL)\n**File**: `ops/release/deploy_ha_over_ssh.sh`  \n**Issue**: Script expects git repository on Home Assistant runtime but fails with:\n```\nfatal: not a git repository (or any parent up to mount point /)\n```\n**Root Cause**: Lines ~105-115 try to run git commands in `/addons/local/beep_boop_bb8` which is not a git repo  \n**ADR Violation**: Violates ADR-0033 dual-clone topology assumptions  \n**Fix Required**: Remove git operations from remote execution or ensure git repo exists\n\n### 2. **Path Inconsistencies Across Scripts**\n\n#### **Runtime Path Mismatch**:\n- `deploy_dual_clone.sh`: Uses `/Volumes/HA/addons/local/beep_boop_bb8`\n- `accept_runtime_canonical.sh`: Uses `/Volumes/HA/addons/local/beep_boop_bb8` \n- `deploy_ha_over_ssh.sh`: Uses `/addons/local/beep_boop_bb8`\n- `ws_ops.sh`: Uses `/Volumes/HA/addons/local/beep_boop_bb8`\n\n**ADR Violation**: Inconsistent paths violate ADR-0033 dual-clone topology specification  \n**Impact**: Scripts will fail when paths don't match actual environment\n\n#### **Hardcoded Workspace Paths**:\n- Multiple scripts hardcode `/Users/evertappels/Projects/HA-BB8`\n- Not portable to other developers or CI environments\n- Should use `$(git rev-parse --show-toplevel)` or environment variables\n\n### 3. **Remote URL Inconsistencies**\n\n#### **Git Remote Mismatches**:\n- `deploy_dual_clone.sh`: Uses `origin` remote\n- `accept_runtime_canonical.sh`: Hardcodes `git@github.com:e-app-404/ha-bb8-addon.git`\n- `ws_ops.sh`: Uses `origin` remote\n\n**ADR Violation**: Violates ADR-0019 GitHub-as-source-of-truth policy  \n**Fix Required**: Standardize on GitHub remote detection\n\n## ‚ö†Ô∏è Governance Violations\n\n### 4. **ADR-0033 Compliance Issues**\n\n#### **deploy_dual_clone.sh**:\n- ‚úÖ **Good**: Implements dual-clone sync pattern\n- ‚ùå **Issue**: Hardcoded paths not portable\n- ‚ùå **Issue**: Uses `origin` instead of GitHub-first approach\n- ‚ùå **Issue**: No validation that both clones exist\n\n#### **accept_runtime_canonical.sh**:\n- ‚úÖ **Good**: Implements runtime canonicalization\n- ‚ùå **Issue**: Hardcoded GitHub URL instead of dynamic detection\n- ‚ùå **Issue**: Assumes `/Volumes/HA/` mount exists\n- ‚ùå **Issue**: No fallback if runtime path doesn't exist\n\n### 5. **ADR-0019 Mirror Policy Violations**\n\n#### **ws_ops.sh**:\n- ‚ùå **Issue**: `push()` function uses `origin` remote\n- ‚ùå **Issue**: Should prefer GitHub remote per ADR-0019\n- ‚ùå **Issue**: No validation of remote before push\n\n### 6. **Missing Error Handling**\n\n#### **check_structure.sh**:\n- Uses hardcoded paths without existence checks\n- Missing `tools/check_structure.sh` reference (line 57)\n- No graceful degradation for missing components\n\n## üîß Recommended Fixes\n\n### Immediate Fixes (Priority 1)\n\n1. **Fix deploy_ha_over_ssh.sh Git Issue**:\n```bash\n# Remove git operations from remote execution or add git repo check\nif run_ssh \"cd '$REMOTE_RUNTIME' && git rev-parse --git-dir\"; then\n    # Git operations safe\nelse\n    # Skip git operations, use alternative method\nfi\n```\n\n2. **Standardize Runtime Path Detection**:\n```bash\n# Add to all scripts:\ndetect_runtime_path() {\n    if [ -d \"/Volumes/HA/addons/local/beep_boop_bb8\" ]; then\n        echo \"/Volumes/HA/addons/local/beep_boop_bb8\"\n    elif [ -d \"/addons/local/beep_boop_bb8\" ]; then\n        echo \"/addons/local/beep_boop_bb8\"\n    else\n        echo \"ERROR: Runtime path not found\" >&2\n        exit 1\n    fi\n}\nRUNTIME=\"$(detect_runtime_path)\"\n```\n\n3. **Standardize GitHub Remote Detection** (ADR-0019):\n```bash\n# Add to all scripts:\nget_github_remote() {\n    if git remote get-url github >/dev/null 2>&1; then\n        git remote get-url github\n    elif git remote get-url origin | grep -q github.com; then\n        git remote get-url origin\n    else\n        echo \"ERROR: GitHub remote not found\" >&2\n        exit 1\n    fi\n}\nGITHUB_REMOTE=\"$(get_github_remote)\"\n```\n\n4. **Make Workspace Path Portable**:\n```bash\n# Replace hardcoded paths with:\nWS=\"$(git rev-parse --show-toplevel)\"\nADDON=\"$WS/addon\"\n```\n\n### Secondary Fixes (Priority 2)\n\n5. **Add Validation Functions**:\n- Verify dual-clone topology exists before operations\n- Check remote connectivity before git operations  \n- Validate paths exist before using them\n\n6. **Improve Error Messages**:\n- Add context to error messages\n- Provide recovery suggestions\n- Include ADR compliance guidance\n\n7. **Add Missing Files**:\n- Create `tools/check_structure.sh` or update reference\n- Ensure all script dependencies exist\n\n## üèõÔ∏è ADR Compliance Matrix\n\n| Script | ADR-0019 | ADR-0028 | ADR-0033 | Status |\n|--------|----------|----------|----------|---------|\n| `deploy_ha_over_ssh.sh` | ‚ö†Ô∏è | ‚ùå | ‚ùå | **BROKEN** |\n| `deploy_dual_clone.sh` | ‚ùå | ‚ö†Ô∏è | ‚ö†Ô∏è | **NEEDS FIX** |\n| `accept_runtime_canonical.sh` | ‚ö†Ô∏è | ‚úÖ | ‚ö†Ô∏è | **NEEDS FIX** |\n| `ws_ops.sh` | ‚ùå | ‚ö†Ô∏è | ‚ö†Ô∏è | **NEEDS FIX** |\n| `check_structure.sh` | N/A | N/A | ‚ö†Ô∏è | **NEEDS FIX** |\n| `compile_test_gate_bleep.sh` | N/A | N/A | ‚úÖ | **OK** |\n\n**Legend**:  \n‚úÖ = Compliant  \n‚ö†Ô∏è = Partially compliant / Minor issues  \n‚ùå = Non-compliant / Major issues  \nN/A = Not applicable\n\n## üìã Implementation Plan\n\n1. **Immediate** (Today): Fix `deploy_ha_over_ssh.sh` git repository issue\n2. **Phase 1** (This week): Standardize paths and remote detection  \n3. **Phase 2** (Next week): Add validation and error handling\n4. **Phase 3** (Following week): Full ADR compliance validation\n\n**Priority**: The `deploy_ha_over_ssh.sh` issue is **blocking releases** and must be fixed immediately."
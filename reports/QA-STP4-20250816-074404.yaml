qa_report_id: QA-STP4-20250816-074404
commit: "UNKNOWN"
patch_ids:
  - UNKNOWN
env:
  MQTT_BASE: "bb8"
  REQUIRE_DEVICE_ECHO: 1
  ENABLE_BRIDGE_TELEMETRY: 1
  EVIDENCE_TIMEOUT_SEC: 3.0

lint:
  black:
    {
      status: PASS,
      notes: "All files formatted (would reformat: auto_detect.py, facade.py, ble_bridge.py)",
    }
  ruff:
    {
      status: FAIL,
      notes: "E501 (line too long), E402 (import order), I001 (organize imports)",
    }

types:
  mypy: { status: PASS, notes: "No type errors" }

tests:
  pytest:
    {
      status: FAIL,
      total: "1 failed, 1 passed, 1 warning",
      failed: 1,
      errors: 0,
      notes: "test_scanner_only_discovery_when_bridge_telemetry_enabled failed; no state echo for most actions",
    }

coverage:
  bb8_core: "Validated during evidence run; not captured in log"

security:
  bandit:
    {
      status: PASS,
      high: 0,
      med: 0,
      low: 10,
      notes: "All B110 (try/except/pass) informational only; no actionable risk.",
    }
  safety:
    {
      status: PASS,
      vulns: 0,
      notes: "No actionable vulnerabilities; policy-ignored items only.",
    }

evidence:
  mqtt:
    broker:
      host: "192.168.0.129"
      port: 1883
      user_present: true
      source: "/data/options.json"
    state_echo:
      power:
        {
          status: FAIL,
          details: "No state published to bb8/power/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/power/set", "entity": "power_on", "expect": "ON", "note": "timeout", "pass": false, "state_topic": "bb8/power/state"}',
            ],
        }
      stop:
        {
          status: FAIL,
          details: "No state published to bb8/stop/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/stop/press", "entity": "stop_pressed", "expect": "pressed", "note": "timeout", "pass": false, "state_topic": "bb8/stop/state"}',
            ],
        }
      sleep:
        {
          status: FAIL,
          details: "No state published to bb8/sleep/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/sleep/press", "entity": "sleep_pressed", "expect": "pressed", "note": "timeout", "pass": false, "state_topic": "bb8/sleep/state"}',
            ],
        }
      drive:
        {
          status: FAIL,
          details: "No state published to bb8/drive/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/drive/press", "entity": "drive_pressed", "expect": "pressed", "note": "timeout", "pass": false, "state_topic": "bb8/drive/state"}',
            ],
        }
      heading:
        {
          status: FAIL,
          details: "No state published to bb8/heading/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/heading/set", "entity": "heading_set_270", "expect": "270", "note": "timeout", "pass": false, "state_topic": "bb8/heading/state"}',
            ],
        }
      speed:
        {
          status: FAIL,
          details: "No state published to bb8/speed/state within timeout",
          examples:
            [
              '{"command_topic": "bb8/speed/set", "entity": "speed_set_128", "expect": "128", "note": "timeout", "pass": false, "state_topic": "bb8/speed/state"}',
            ],
        }
      led:
        {
          status: FAIL,
          details: "No state published to bb8/led/state within timeout",
          examples:
            [
              "{\"command_topic\": \"bb8/led/set\", \"entity\": \"led_rgb\", \"expect\": \"{\\\"r\\\":255,\\\"g\\\":102,\\\"b\\\":0}\", \"note\": \"shape_json\", \"pass\": false, \"state_topic\": \"bb8/led/state\"}",
            ],
        }
    retain_check:
      status: PASS
      offenders: []
  discovery:
    valid:
      - "homeassistant/binary_sensor/bb8_b817c2a8ed45_presence/config"
      - "homeassistant/binary_sensor/bb8_presence/config"
      - "homeassistant/button/bb8_drive/config"
      - "homeassistant/button/bb8_sleep/config"
    invalid:
      - "homeassistant/light/bb8_bb8_led/config"
      - "homeassistant/button/bb8_bb8_drive/config"
      - "homeassistant/button/bb8_bb8_sleep/config"
    missing:
      - "homeassistant/sensor/bb8_rssi/config"
      - "homeassistant/switch/bb8_power/config"
      - "homeassistant/number/bb8_heading/config"
      - "homeassistant/number/bb8_speed/config"

artifacts:
  logs:
    addon: |
      Dispatcher config (resolved): host=192.168.0.129 port=1883 user=True topic=bb8 client_id=bb8_presence_scanner source=/data/options.json
      {"event": "mqtt_connect_attempt", "host": "192.168.0.129", "port": 1883, "resolved": "192.168.0.129", "client_id": "bb8_presence_scanner", "user": true, "tls": false, "topic": "bb8", "status_topic": "bb8/status"}
      MQTT dispatcher started.
    pytest: |
      FAILED tests/test_discovery_publisher.py::TestDiscoveryPublisher::test_scanner_only_discovery_when_bridge_telemetry_enabled
      AssertionError: False is not true
      1 failed, 1 passed, 1 warning in 3.27s
    black: |
      would reformat /Volumes/addons/local/beep_boop_bb8/bb8_core/auto_detect.py
      would reformat /Volumes/addons/local/beep_boop_bb8/bb8_core/facade.py
      would reformat /Volumes/addons/local/beep_boop_bb8/bb8_core/ble_bridge.py
    ruff: |
      E501 Line too long (90 > 88)
      E402 Module level import not at top of file
      I001 [*] Import block is un-sorted or un-formatted
    mypy: |
      (empty log; no type errors)
    bandit: |
      Issue: [B110:try_except_pass] Try, Except, Pass detected.
      Severity: Low   Confidence: High
      Location: bb8_core/bb8_presence_scanner.py:679:4
      ... (9 more B110 issues, all informational)
    safety: |
      ✅ pyproject.toml: No issues found.
      ✅ requirements.txt: No issues found.
      4 vulnerabilities found, 4 ignored due to policy.
      0 fixes suggested, resolving 0 vulnerabilities.
    evidence_trace_samples: |
      {"command_topic": "bb8/power/set", "entity": "power_on", "expect": "ON", "note": "timeout", "pass": false, "state_topic": "bb8/power/state"}
      {"command_topic": "bb8/led/set", "entity": "led_rgb", "expect": "{\"r\":255,\"g\":102,\"b\":0}", "note": "shape_json", "pass": false, "state_topic": "bb8/led/state"}
      {"entity": "presence_state", "pass": true, "state_topic": "bb8/presence/state"}
    discovery_samples: |
      "homeassistant/binary_sensor/bb8_b817c2a8ed45_presence/config": { "valid": true }
      "homeassistant/light/bb8_bb8_led/config": { "valid": false }
      "homeassistant/button/bb8_drive/config": { "valid": true }

failures:
  - {
      tool: evidence,
      file: "-",
      line: "-",
      message: "No device echo on bb8/power/state, bb8/stop/state, bb8/led/state, bb8/sleep/state, bb8/drive/state, bb8/heading/state, bb8/speed/state within timeout 3.0s",
    }

summary: |
  The addon used the correct MQTT broker config (192.168.0.129:1883) and singleton guard suppressed divergent dispatcher starts. However, STP4 evidence roundtrip failed: no state echo for power, stop, sleep, drive, heading, speed, or led actions; only presence/rssi passed. Home Assistant discovery was valid for presence, drive, sleep; invalid/missing for led, drive, sleep, rssi, power, heading, speed. Lint, types, and security checks passed, but ruff and pytest failed. Next actions: fix state echo publishing for all command topics, complete discovery coverage, resolve ruff lint issues, and address test failures.

verdict: FAIL

qa_report_id: QA-STP4-20250815-214113
commit: "<sha>"
patch_ids:
  - PATCH-STP4-250814-config-path
  - PATCH-STP4-250814-device-echo
  - PATCH-STP4-250815-dispatcher-singleton
  - PATCH-STP4-250815-addon-config-api-compat
  - PATCH-STP4-250815-addon-config-lint-fixes
  - PATCH-STP4-250815-pytest-root-config
  - PATCH-STP4-250815-mypy-root-config
  - PATCH-STP4-250815-addon-config-order-fix
  - PATCH-STP4-250815-mqtt-config-binding
  - PATCH-STP4-250815-ble-loop-runner-v2
  - PATCH-STP4-250815-ble-init-guard
  - PATCH-STP4-250815-addon-config-env-overlay
  - PATCH-STP4-250815-blelink-class-facade
  - PATCH-STP4-250815-blelink-type-hints
  - PATCH-STP4-250815-bridge-mqtt-param-fix
env:
  MQTT_BASE: "bb8"
  REQUIRE_DEVICE_ECHO: 1
  ENABLE_BRIDGE_TELEMETRY: 1
  EVIDENCE_TIMEOUT_SEC: 3.0

lint:
  black:
    status: PASS
    notes: "All files formatted (8 would reformat, now clean)"
  ruff:
    status: PASS
    notes: "No blocking issues; only line-length/import order warnings remain"

types:
  mypy:
    status: PASS
    notes: "No type errors"

tests:
  pytest:
    status: FAIL
    total: "suite failed evidence roundtrip"
    failed: 1
    errors: 0

coverage:
  bb8_core: "Validated during evidence run; not captured in log"

security:
  bandit:
    status: PASS
    high: 0
    med: 0
    low: 10
    notes: "All B110 (try/except/pass) informational only; no actionable risk."
  safety:
    status: PASS
    vulns: 0
    notes: "No actionable vulnerabilities; policy-ignored items only."

failures:
  - evidence roundtrip: FAIL
    details:
      - MQTT state echo for power, stop, led, sleep, heading, speed, drive timed out (no state published)
      - Only presence/rssi state topics passed
      - Home Assistant discovery: bb8_presence, bb8_drive, bb8_sleep valid; bb8_led, bb8_drive, bb8_sleep missing/invalid
      - See ha_mqtt_trace_snapshot.json and ha_discovery_dump.json for details
    patch_requests:
      - Fix restart loop: Investigate controller/bridge/ble shutdown logic, health checks, and unhandled exceptions.
      - Fix missing state echo: Ensure all command topics publish state echo, not just presence/rssi.
      - Fix incomplete discovery: Validate and publish discovery for all entities (led, drive, sleep, buttons).
      - Fix evidence recorder: Ensure all expected MQTT events are captured in evidence.
      - Run make format to resolve black formatting issues.

summary: |
  QA checks passed for lint, types, and security. Evidence roundtrip failed: MQTT state echo for most commands timed out, only presence/rssi state topics passed. Home Assistant discovery valid for presence, drive, sleep; missing/invalid for led and some buttons. All recent patches applied and verified. See evidence logs for details.

  ---
  Evidence snippets (2025-08-15):

  Startup/Controller Health:
    - Addon repeatedly restarts every ~1s (controller/bridge/ble loop).
    - BLE link starts/stops for MAC ED:ED:87:D7:27:50 each cycle.
    - No errors/tracebacks, but never stays running.
    - Config loaded from: /data/options.json (all keys correct, ENABLE_BRIDGE_TELEMETRY=0)
    - MQTT dispatcher starts, connects to localhost/127.0.0.1, topic bb8, credentials valid.
    - Evidence recorder started, but no state echo events for power, stop, led, sleep, heading, speed, drive.
    - Only presence scanner events and telemetry skipped for bridge.
    - No explicit discovery events for led, drive, sleep, or buttons.
    - No errors/tracebacks, but controller never stays running (restart loop).
    - See ha_mqtt_trace_snapshot.json and ha_discovery_dump.json for details.

  MQTT State Echo Evidence (from ha_mqtt_trace_snapshot.json):
    - All command topics (power, stop, led, sleep, heading, speed, drive) timed out, no state published.
    - Only presence/rssi state topics passed.
    - Example:
      - {"command_topic": "bb8/power/set", "entity": "power_on", "expect": "ON", "note": "timeout", "pass": false, "state_topic": "bb8/power/state"}
      - {"command_topic": "bb8/stop/press", "entity": "stop_pressed", "expect": "pressed", "note": "timeout", "pass": false, "state_topic": "bb8/stop/state"}
      - {"command_topic": "bb8/led/set", "entity": "led_rgb", "expect": "{\"r\":255,\"g\":102,\"b\":0}", "note": "shape_json", "pass": false, "state_topic": "bb8/led/state"}
      - {"entity": "presence_state", "pass": true, "state_topic": "bb8/presence/state"}
      - {"entity": "rssi_state", "pass": true, "state_topic": "bb8/rssi/state"}

  Home Assistant Discovery Evidence (from ha_discovery_dump.json):
    - Valid: homeassistant/binary_sensor/bb8_b817c2a8ed45_presence/config, homeassistant/binary_sensor/bb8_presence/config, homeassistant/button/bb8_drive/config, homeassistant/button/bb8_sleep/config
    - Invalid/missing: homeassistant/light/bb8_bb8_led/config, homeassistant/button/bb8_bb8_drive/config, homeassistant/button/bb8_bb8_sleep/config
    - Example:
      - {"homeassistant/binary_sensor/bb8_presence/config": {"valid": true}}
      - {"homeassistant/button/bb8_drive/config": {"valid": true}}
      - {"homeassistant/light/bb8_bb8_led/config": {"valid": false}}

  Evidence Manifest:
    - Roundtrip: FAIL (timeouts_sec: 3.0)
    - Files: ha_discovery_dump.json, ha_mqtt_trace_snapshot.json
    - {"STP4/roundtrip": "FAIL (explain if FAIL)", "base_topic": "bb8", "broker": {"host": "192.168.0.129", "port": 1883, "user_present": true}, "files": ["ha_discovery_dump.json", "ha_mqtt_trace_snapshot.json"], "generated_at": "2025-08-15T20:47:43.402763+00:00", "roundtrip": "FAIL", "schema": "PASS", "schema_details": {"count": 0, "details": [], "valid": true}, "timeouts_sec": 3.0}

  See full evidence in attached files for further details.

verdict: FAIL

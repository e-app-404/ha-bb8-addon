[CONFIG] No configuration found in options.json or YAML.
[CONFIG] No configuration found in options.json or YAML.
[CONFIG] No configuration found in options.json or YAML.
{"event": "safety_controller_init", "min_interval_ms": 50, "max_duration_ms": 2000, "max_speed": 180}
============================================================
ðŸš€ B3 Emergency Stop Safety Demo - Post-Rework
============================================================
[LOGGING DEBUG] Resolved LOG_PATH candidate: /Volumes/addons/docs/reports/ha_bb8_addon.log
[LOGGING DEBUG] Writable: True
2025-10-10 17:07:24,039 INFO:bb8_core.logging_setup: {'event': 'safety_controller_init', 'min_interval_ms': 50, 'max_duration_ms': 2000, 'max_speed': 180}
[CONFIG] No configuration found in options.json or YAML.
{"event": "version_probe", "bleak": "0.22.3", "spherov2": "0.12.1"}
2025-10-10 17:07:24,528 INFO:bb8_core.logging_setup: {'event': 'version_probe', 'bleak': '0.22.3', 'spherov2': '0.12.1'}
{"event": "safety_speed_clamped", "original": 300, "clamped": 180, "max_allowed": 180}
âœ… Facade initialized with safety controller

ðŸ§ª Test 1: Speed Clamping (separate from rate limiting)
2025-10-10 17:07:24,537 WARNING:bb8_core.logging_setup: {'event': 'safety_speed_clamped', 'original': 300, 'clamped': 180, 'max_allowed': 180}
{"event": "safety_estop_activated", "reason": "Demo emergency stop", "timestamp": 1760112444.537159}
âœ… Speed clamping: 300 â†’ 180 (max: 180)

ðŸ§ª Test 2: Rate Limiting (only affects execution)
âœ… First gate_drive() passed
âœ… Rate limit triggered: Drive command rate limit exceeded - 0.0ms < 50ms

ðŸ§ª Test 3: Facade Authoritative Estop Gating
2025-10-10 17:07:24,537 WARNING:bb8_core.logging_setup: {'event': 'safety_estop_activated', 'reason': 'Demo emergency stop', 'timestamp': 1760112444.537159}
{"event": "facade_stop_success"}
ðŸ›‘ BB-8 stopped
ðŸ“¡ MQTT Publish: bb8/stop/state = pressed
2025-10-10 17:07:24,537 INFO:bb8_core.logging_setup: {'event': 'facade_stop_success'}
{"event": "facade_estop_activated", "reason": "Demo emergency stop"}
ðŸ“¡ MQTT Publish: bb8/status/telemetry = {
  "connected": true,
  "estop": true,
  "last_cmd_ts": null,
  "battery_pct": 0,
  "ts": "2025-10-10T16:07:24.fZ"
}
2025-10-10 17:07:24,546 WARNING:bb8_core.logging_setup: {'event': 'facade_estop_activated', 'reason': 'Demo emergency stop'}
{"event": "facade_drive_blocked_estop", "speed": 100, "heading": 90, "duration_ms": 1000, "reason": "Motion blocked by emergency stop: Demo emergency stop"}
âœ… Emergency stop activated
2025-10-10 17:07:24,546 WARNING:bb8_core.logging_setup: {'event': 'facade_drive_blocked_estop', 'speed': 100, 'heading': 90, 'duration_ms': 1000, 'reason': 'Motion blocked by emergency stop: Demo emergency stop'}
{"event": "safety_estop_cleared", "previous_reason": "Demo emergency stop", "timestamp": 1760112444.5469272}
ðŸ“¡ MQTT Publish: bb8/event/rejected = {
  "cmd": "drive",
  "reason": "Motion blocked by emergency stop: Demo emergency stop"
}
âœ… Drive command blocked during estop
2025-10-10 17:07:24,546 INFO:bb8_core.logging_setup: {'event': 'safety_estop_cleared', 'previous_reason': 'Demo emergency stop', 'timestamp': 1760112444.5469272}
{"event": "facade_estop_cleared", "reason": "Emergency stop cleared (was: Demo emergency stop)"}
ðŸ“¡ MQTT Publish: bb8/status/telemetry = {
  "connected": true,
  "estop": false,
  "last_cmd_ts": null,
  "battery_pct": 0,
  "ts": "2025-10-10T16:07:24.fZ"
}
2025-10-10 17:07:24,547 INFO:bb8_core.logging_setup: {'event': 'facade_estop_cleared', 'reason': 'Emergency stop cleared (was: Demo emergency stop)'}
{"event": "facade_drive_success", "speed": 50, "heading": 180, "duration_ms": 500}
âœ… Emergency stop cleared
ðŸ¤– BB-8 rolling: speed=50, heading=180Â°, duration=500ms
ðŸ“¡ MQTT Publish: bb8/drive/state = {
  "speed": 50,
  "heading": 180,
  "duration_ms": 500
}
2025-10-10 17:07:24,608 INFO:bb8_core.logging_setup: {'event': 'facade_drive_success', 'speed': 50, 'heading': 180, 'duration_ms': 500}
{"event": "facade_drive_success", "speed": 75, "heading": 270, "duration_ms": 800}
âœ… Drive command works after estop cleared

ðŸ§ª Test 4: Telemetry Publishing
ðŸ“¡ MQTT Publish: bb8/status/telemetry = {
  "connected": true,
  "estop": false,
  "last_cmd_ts": "2025-10-10T16:07:24.fZ",
  "battery_pct": 85,
  "ts": "2025-10-10T16:07:24.fZ"
}
âœ… Telemetry published successfully (no coroutine errors)

ðŸ§ª Test 5: Complete Safety Sequence
ðŸ¤– BB-8 rolling: speed=75, heading=270Â°, duration=800ms
ðŸ“¡ MQTT Publish: bb8/drive/state = {
  "speed": 75,
  "heading": 270,
  "duration_ms": 800
}
2025-10-10 17:07:24,669 INFO:bb8_core.logging_setup: {'event': 'facade_drive_success', 'speed': 75, 'heading': 270, 'duration_ms': 800}
{"event": "safety_estop_activated", "reason": "Complete sequence test", "timestamp": 1760112444.7427242}
âœ… Motion allowed before estop
2025-10-10 17:07:24,742 WARNING:bb8_core.logging_setup: {'event': 'safety_estop_activated', 'reason': 'Complete sequence test', 'timestamp': 1760112444.7427242}
{"event": "facade_stop_success"}
ðŸ›‘ BB-8 stopped
ðŸ“¡ MQTT Publish: bb8/stop/state = pressed
2025-10-10 17:07:24,743 INFO:bb8_core.logging_setup: {'event': 'facade_stop_success'}
{"event": "facade_estop_activated", "reason": "Complete sequence test"}
ðŸ“¡ MQTT Publish: bb8/status/telemetry = {
  "connected": true,
  "estop": true,
  "last_cmd_ts": "2025-10-10T16:07:24.fZ",
  "battery_pct": 85,
  "ts": "2025-10-10T16:07:24.fZ"
}
2025-10-10 17:07:24,743 WARNING:bb8_core.logging_setup: {'event': 'facade_estop_activated', 'reason': 'Complete sequence test'}
{"event": "facade_drive_blocked_estop", "speed": 100, "heading": 0, "duration_ms": 500, "reason": "Motion blocked by emergency stop: Complete sequence test"}
âœ… Estop activated, motion stopped
2025-10-10 17:07:24,743 WARNING:bb8_core.logging_setup: {'event': 'facade_drive_blocked_estop', 'speed': 100, 'heading': 0, 'duration_ms': 500, 'reason': 'Motion blocked by emergency stop: Complete sequence test'}
{"event": "facade_drive_blocked_estop", "speed": 50, "heading": 90, "duration_ms": 500, "reason": "Motion blocked by emergency stop: Complete sequence test"}
ðŸ“¡ MQTT Publish: bb8/event/rejected = {
  "cmd": "drive",
  "reason": "Motion blocked by emergency stop: Complete sequence test"
}
âœ… Motion attempt 1 rejected during estop
2025-10-10 17:07:24,743 WARNING:bb8_core.logging_setup: {'event': 'facade_drive_blocked_estop', 'speed': 50, 'heading': 90, 'duration_ms': 500, 'reason': 'Motion blocked by emergency stop: Complete sequence test'}
{"event": "facade_drive_blocked_estop", "speed": 25, "heading": 180, "duration_ms": 500, "reason": "Motion blocked by emergency stop: Complete sequence test"}
ðŸ“¡ MQTT Publish: bb8/event/rejected = {
  "cmd": "drive",
  "reason": "Motion blocked by emergency stop: Complete sequence test"
}
âœ… Motion attempt 2 rejected during estop
2025-10-10 17:07:24,743 WARNING:bb8_core.logging_setup: {'event': 'facade_drive_blocked_estop', 'speed': 25, 'heading': 180, 'duration_ms': 500, 'reason': 'Motion blocked by emergency stop: Complete sequence test'}
{"event": "safety_estop_cleared", "previous_reason": "Complete sequence test", "timestamp": 1760112444.7435899}
ðŸ“¡ MQTT Publish: bb8/event/rejected = {
  "cmd": "drive",
  "reason": "Motion blocked by emergency stop: Complete sequence test"
}
âœ… Motion attempt 3 rejected during estop
2025-10-10 17:07:24,743 INFO:bb8_core.logging_setup: {'event': 'safety_estop_cleared', 'previous_reason': 'Complete sequence test', 'timestamp': 1760112444.7435899}
{"event": "facade_estop_cleared", "reason": "Emergency stop cleared (was: Complete sequence test)"}
ðŸ“¡ MQTT Publish: bb8/status/telemetry = {
  "connected": true,
  "estop": false,
  "last_cmd_ts": "2025-10-10T16:07:24.fZ",
  "battery_pct": 85,
  "ts": "2025-10-10T16:07:24.fZ"
}
2025-10-10 17:07:24,743 INFO:bb8_core.logging_setup: {'event': 'facade_estop_cleared', 'reason': 'Emergency stop cleared (was: Complete sequence test)'}
{"event": "facade_drive_success", "speed": 60, "heading": 45, "duration_ms": 600}
âœ… Estop cleared
ðŸ¤– BB-8 rolling: speed=60, heading=45Â°, duration=600ms
ðŸ“¡ MQTT Publish: bb8/drive/state = {
  "speed": 60,
  "heading": 45,
  "duration_ms": 600
}
2025-10-10 17:07:24,804 INFO:bb8_core.logging_setup: {'event': 'facade_drive_success', 'speed': 60, 'heading': 45, 'duration_ms': 600}
âœ… Motion allowed after estop cleared

============================================================
ðŸŽ‰ B3 Safety Demo Complete
âœ… All core safety features working:
  â€¢ Validation/clamping decoupled from rate limiting
  â€¢ Authoritative estop gating at facade layer
  â€¢ Fixed telemetry publishing (no coroutine errors)
  â€¢ Complete motion safety lifecycle
============================================================
